# ğŸ“š ê¸°ì¡´ ì½”ë“œ ì£¼ìš” í•¨ìˆ˜ ì°¸ê³  ìë£Œ

## 1. RSC Flight Data ì¶”ì¶œ í•¨ìˆ˜

**íŒŒì¼**: `src/crawlers/zighang-full.js:188-226`

```javascript
/**
 * RSC flight dataì—ì„œ "recruitment":{...} JSON ê°ì²´ ì¶”ì¶œ
 */
function extractRecruitmentFromRsc(html) {
  // RSC chunksë¥¼ ë””ì½”ë”©í•˜ì—¬ í•©ì¹˜ê¸°
  const rscChunks = [];
  const regex = /self\.__next_f\.push\(\[1,"((?:[^"\\]|\\.)*)"\]\)/g;
  let match;
  while ((match = regex.exec(html)) !== null) {
    const decoded = match[1]
      .replace(/\\n/g, '\n')
      .replace(/\\"/g, '"')
      .replace(/\\\\/g, '\\');
    rscChunks.push(decoded);
  }
  const fullRsc = rscChunks.join('');

  // "recruitment":{ ìœ„ì¹˜ ì°¾ê¸°
  const recruitStart = fullRsc.indexOf('"recruitment":{');
  if (recruitStart === -1) return null;

  // ì¤‘ê´„í˜¸ ë§¤ì¹­ìœ¼ë¡œ JSON ê°ì²´ ë²”ìœ„ ì¶”ì¶œ
  const objStart = recruitStart + '"recruitment":'.length;
  let depth = 0;
  let objEnd = objStart;
  for (let i = objStart; i < fullRsc.length; i++) {
    if (fullRsc[i] === '{') depth++;
    else if (fullRsc[i] === '}') {
      depth--;
      if (depth === 0) {
        objEnd = i + 1;
        break;
      }
    }
  }

  try {
    return JSON.parse(fullRsc.substring(objStart, objEnd));
  } catch {
    return null;
  }
}
```

---

## 2. ProseMirror JSON â†’ í‰ë¬¸ ë³€í™˜

**íŒŒì¼**: `src/crawlers/zighang-full.js:109-128`

```javascript
/**
 * ProseMirror/TipTap JSON doc â†’ í‰ë¬¸ í…ìŠ¤íŠ¸ ë³€í™˜
 */
function prosemirrorToText(doc) {
  if (!doc || typeof doc === 'string') return doc || '';
  if (typeof doc !== 'object') return String(doc);

  function walk(node) {
    if (!node) return '';
    if (node.type === 'text') return node.text || '';
    if (!node.content) return '';
    const parts = node.content.map(walk);
    // ë¸”ë¡ ë…¸ë“œ ì‚¬ì´ì— ì¤„ë°”ê¿ˆ ì¶”ê°€
    const blockTypes = ['paragraph', 'heading', 'bulletList', 'orderedList', 'listItem', 'blockquote'];
    if (blockTypes.includes(node.type)) {
      return parts.join('') + '\n';
    }
    return parts.join('');
  }
  return walk(doc).replace(/\n{3,}/g, '\n\n').trim();
}
```

---

## 3. í‰ë¬¸ í…ìŠ¤íŠ¸ â†’ ì„¹ì…˜ ë¶„ë¦¬

**íŒŒì¼**: `src/crawlers/zighang-full.js:133-183`

```javascript
/**
 * í‰ë¬¸ í…ìŠ¤íŠ¸ë¥¼ ì„¹ì…˜ í—¤ë”© ê¸°ì¤€ìœ¼ë¡œ detail í•„ë“œë¡œ ë¶„ë¦¬
 */
function parseDetailSections(text) {
  const empty = {
    intro: '',
    main_tasks: '',
    requirements: '',
    preferred_points: '',
    benefits: '',
    work_conditions: '',
    raw_content: ''
  };
  if (!text) return empty;

  const sectionMap = {
    main_tasks: /^(ë‹´ë‹¹ì—…ë¬´|ì£¼ìš”ì—…ë¬´|ì—…ë¬´\s*ë‚´ìš©|ì§ë¬´\s*ë‚´ìš©|í•˜ëŠ”\s*ì¼|ì—…ë¬´\s*ì†Œê°œ|ì—…ë¬´\s*ì„¤ëª…|ëª¨ì§‘\s*ì •ë³´|ëª¨ì§‘\s*ë¶„ì•¼)/,
    requirements: /^(ìê²©ìš”ê±´|ìê²©\s*ì¡°ê±´|ì§€ì›\s*ìê²©|í•„ìˆ˜\s*ìš”ê±´|í•„ìˆ˜\s*ì¡°ê±´|ì‘ëª¨\s*ìê²©|ì±„ìš©\s*ì¡°ê±´|í•„ìš”\s*ì—­ëŸ‰|ì§€ì›\s*ì¡°ê±´)/,
    preferred_points: /^(ìš°ëŒ€ì‚¬í•­|ìš°ëŒ€\s*ì¡°ê±´|ìš°ëŒ€\s*ìš”ê±´|ì´ëŸ°\s*ë¶„.*ìš°ëŒ€|ì´ëŸ°\s*ë¶„.*í™˜ì˜|ìš°ëŒ€\s*ì—­ëŸ‰)/,
    benefits: /^(ë³µë¦¬í›„ìƒ|í˜œíƒ|ë³µì§€|ê·¼ë¬´\s*í˜œíƒ|ì§ì›\s*í˜œíƒ|ì‚¬ë‚´\s*ë³µì§€|ë³µì§€\s*ë°|ë³´ìƒ\s*ë°)/,
    work_conditions: /^(ê·¼ë¬´í™˜ê²½|ê·¼ë¬´\s*ì¡°ê±´|ê·¼ë¬´\s*ì‹œê°„|ê·¼ë¬´\s*í˜•íƒœ|ê¸‰ì—¬|ì—°ë´‰|ê·¼ë¬´í™˜ê²½\/ê¸‰ì—¬|ì²˜ìš°\s*ì¡°ê±´|ëª¨ì§‘\s*ì¸ì›|ëª¨ì§‘\s*ì¡°ê±´|ê·¼ë¬´\s*ì§€ì—­|ê·¼ë¬´\s*ì¥ì†Œ|ê·¼ë¬´\s*ì¼ì‹œ|ê·¼ë¬´\s*ìš”ì¼)/,
  };

  const lines = text.split('\n');
  const result = { ...empty, raw_content: text };
  let currentSection = 'intro';

  for (const line of lines) {
    const trimmed = line.trim();
    if (!trimmed) {
      result[currentSection] += '\n';
      continue;
    }

    let matched = false;
    for (const [key, regex] of Object.entries(sectionMap)) {
      if (regex.test(trimmed)) {
        currentSection = key;
        matched = true;
        break;
      }
    }

    // ì œì¶œì„œë¥˜, ì „í˜•ì ˆì°¨, ì ‘ìˆ˜ë°©ë²•, ë§ˆê°ê¸°í•œ ë“± ê¸°íƒ€ ì„¹ì…˜ì€ work_conditionsì— í¬í•¨
    if (!matched && /^(ì œì¶œì„œë¥˜|ì „í˜•ì ˆì°¨|ì ‘ìˆ˜ë°©ë²•|ë§ˆê°ê¸°í•œ|ì±„ìš©\s*ì ˆì°¨|ì§€ì›\s*ë°©ë²•|ì„œë¥˜\s*ì ‘ìˆ˜|ì ‘ìˆ˜\s*ê¸°ê°„|ì „í˜•\s*ë°©ë²•)/.test(trimmed)) {
      currentSection = 'work_conditions';
      matched = true;
    }

    // ì„¹ì…˜ í—¤ë” ë¼ì¸ë„ ë‚´ìš©ì— í¬í•¨
    result[currentSection] += trimmed + '\n';
  }

  // trim all
  for (const key of Object.keys(result)) {
    if (key === 'raw_content') continue;
    result[key] = result[key].replace(/\n{3,}/g, '\n\n').trim();
  }
  result.raw_content = result.raw_content.replace(/\n{3,}/g, '\n\n').trim();

  return result;
}
```

---

## 4. í˜„ì¬ fetchJobDetail í•¨ìˆ˜ (ìˆ˜ì • ì „)

**íŒŒì¼**: `src/crawlers/zighang-full.js:233-346`

```javascript
export async function fetchJobDetail(entry) {
  try {
    const response = await axios.get(entry.url, {
      headers: {
        ...HEADERS,
        'Accept': 'text/html',
      },
      timeout: 10000,
    });

    const html = response.data;
    const $ = cheerio.load(html);

    // 1ì°¨: RSC flight dataì—ì„œ í’ë¶€í•œ ë°ì´í„° ì¶”ì¶œ
    const recruitment = extractRecruitmentFromRsc(html);

    if (recruitment) {
      return {
        id: entry.id,
        source: 'zighang',

        company: recruitment.company?.name || '',
        company_id: recruitment.company?.id || null,
        company_image: recruitment.company?.image || null,

        title: recruitment.title || '',
        regions: recruitment.regions || [],
        location: recruitment.regions?.[0] || '',
        career_min: recruitment.careerMin ?? null,
        career_max: recruitment.careerMax ?? null,
        employee_types: recruitment.employeeTypes || [],
        deadline_type: recruitment.deadlineType || null,
        end_date: recruitment.endDate || null,

        depth_ones: recruitment.depthOnes || [],
        depth_twos: recruitment.depthTwos || [],
        keywords: recruitment.keywords || [],

        views: recruitment.views || 0,

        // summary/contentë¥¼ í‰ë¬¸ ë³€í™˜ í›„ ì„¹ì…˜ ë¶„ë¦¬
        detail: parseDetailSections(
          prosemirrorToText(recruitment.content) ||
          prosemirrorToText(recruitment.summary) ||
          $('meta[property="og:description"]').attr('content') || ''
        ),

        original_created_at: recruitment.createdAt || null,
        last_modified_at: entry.lastmod?.toISOString() || null,
        crawled_at: new Date().toISOString(),

        is_active: recruitment.status === 'ACTIVE',
      };
    }

    // 2ì°¨ fallback: LD+JSON
    let jobPosting = null;
    $('script[type="application/ld+json"]').each((_, el) => {
      try {
        const data = JSON.parse($(el).html());
        if (data['@type'] === 'JobPosting') jobPosting = data;
      } catch {}
    });

    if (!jobPosting) return null;

    const ogTitle = $('meta[property="og:title"]').attr('content') || '';
    const ogDesc = $('meta[property="og:description"]').attr('content') || '';

    let depthOnes = [];
    const titleMatch = ogTitle.match(/\[.+?\]\s*.+?\s*ì±„ìš©\s*\|\s*(.+)/);
    if (titleMatch) depthOnes = [titleMatch[1].trim()];

    const typeMap = {
      'FULL_TIME': 'ì •ê·œì§',
      'PART_TIME': 'íŒŒíŠ¸íƒ€ì„',
      'CONTRACT': 'ê³„ì•½ì§',
      'INTERN': 'ì¸í„´'
    };
    const employeeTypes = (jobPosting.employmentType || []).map(t => typeMap[t] || t);
    const locations = (jobPosting.jobLocation || []).map(loc =>
      loc?.address?.addressLocality || ''
    ).filter(Boolean);

    return {
      id: entry.id,
      source: 'zighang',

      company: jobPosting.hiringOrganization?.name || '',
      company_id: null,
      company_image: null,

      title: jobPosting.title || '',
      regions: locations,
      location: locations[0] || '',
      career_min: null,  // âš ï¸ LD+JSONì—ì„œëŠ” ì¶”ì¶œ ì•ˆ í•¨
      career_max: null,
      employee_types: employeeTypes,
      deadline_type: null,
      end_date: null,

      depth_ones: depthOnes,
      depth_twos: [],  // âš ï¸ LD+JSONì—ì„œëŠ” ì—†ìŒ
      keywords: [],    // âš ï¸ LD+JSONì—ì„œëŠ” ì—†ìŒ

      views: 0,

      detail: {
        intro: '',
        main_tasks: ogDesc || '',
        requirements: '',
        preferred_points: '',
        benefits: '',
        work_conditions: ''
      },

      original_created_at: jobPosting.datePosted || null,
      last_modified_at: entry.lastmod?.toISOString() || null,
      crawled_at: new Date().toISOString(),

      is_active: true,
    };
  } catch (error) {
    if (error.response?.status === 404) {
      return { id: entry.id, _deleted: true };
    }
    console.error(`  âœ— ${entry.id}: ${error.message}`);
    return null;
  }
}
```

---

## 5. ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜ (ì°¸ê³ ìš©)

**íŒŒì¼**: `web/app/api/jobs/route.ts:142-420`

```typescript
function scoreJob(
  job: JobRow,
  prefs: UserPreferences | null,
  keywordWeights: KeywordWeight[],
  companyPrefs: CompanyPref[],
  learnedWeights: LearnedWeight[] = [],
  companyType: string | null = null,
  isInDB: boolean = false
): { score: number; reasons: string[]; warnings: string[]; matchesFilter: boolean } {
  let score = 50;
  const reasons: string[] = [];
  const warnings: string[] = [];
  let matchesFilter = true;

  // 1. ì§ë¬´ ë§¤ì¹­ (depth_twos ìš°ì„ ) - í•„ìˆ˜ í•„í„°
  if (prefs.preferred_job_types?.length) {
    const jobDepthTwos = job.depth_twos || [];
    let jobMatched = false;

    for (const prefType of prefs.preferred_job_types) {
      // depth_twosì—ì„œ ì •í™• ë§¤ì¹­ (15ì )
      const exactMatch = jobDepthTwos.some(t =>
        t.toLowerCase().includes(prefType.toLowerCase())
      );

      if (exactMatch) {
        score += 15;
        reasons.push(prefType);
        jobMatched = true;
        break;
      }
    }

    // ì§ë¬´ê°€ í•˜ë‚˜ë„ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ í•„í„° ë¶ˆí†µê³¼
    if (!jobMatched) {
      matchesFilter = false;
      score = 0;
      warnings.push('âš ï¸ ì„ í˜¸ ì§ë¬´ ë¶ˆì¼ì¹˜');
    }
  }

  // 2. ì§€ì—­ í•„í„° (ì—„ê²©)
  if (prefs.preferred_locations?.length && job.location) {
    const locationMatch = prefs.preferred_locations.some(loc =>
      job.location!.includes(loc)
    );
    if (!locationMatch) {
      matchesFilter = false;
      warnings.push(`âš ï¸ ${job.location} (ì„ í˜¸ ì§€ì—­ ë¶ˆì¼ì¹˜)`);
    }
  }

  // 3. ê²½ë ¥ í•„í„° (ì—„ê²©)
  if (prefs.career_level) {
    const careerLevels = prefs.career_level.split(',');
    let careerMatched = false;

    for (const level of careerLevels) {
      if (level === 'ì‹ ì…' || level === 'ê²½ë ¥ë¬´ê´€') {
        if (job.career_min === 0 || job.career_min === null) {
          careerMatched = true;
          break;
        }
      }
      // ... ê¸°íƒ€ ê²½ë ¥ ì¡°ê±´
    }

    if (!careerMatched) {
      matchesFilter = false;
      warnings.push(`âš ï¸ ê²½ë ¥ ì¡°ê±´ ë¶ˆì¼ì¹˜`);
    }
  }

  // 4. ê³ ìš©í˜•íƒœ í•„í„°
  if (prefs.work_style?.length && job.employee_types?.length) {
    const match = prefs.work_style.some(ws =>
      job.employee_types!.includes(ws)
    );
    if (!match) {
      matchesFilter = false;
      warnings.push(`âš ï¸ ê³ ìš©í˜•íƒœ ë¶ˆì¼ì¹˜`);
    }
  }

  // 5. ê¸°ì—… ìœ í˜• í•„í„°
  if (prefs.preferred_company_types?.length && companyType) {
    const match = prefs.preferred_company_types.includes(companyType);
    if (!match && companyType !== 'ê¸°íƒ€') {
      matchesFilter = false;
      warnings.push(`âš ï¸ ${companyType} (ì„ í˜¸ ìœ í˜• ë¶ˆì¼ì¹˜)`);
    }
  }

  return { score, reasons, warnings, matchesFilter };
}
```

---

## 6. í•„í„°ë§ í†µê³¼ ì¡°ê±´ ìš”ì•½

```typescript
// web/app/api/jobs/route.ts:658
const passedJobs = scoredJobs.filter(j => j.matchesFilter);

// matchesFilter = true ì¡°ê±´:
// 1. depth_twosì— ì‚¬ìš©ì ì„ í˜¸ ì§ë¬´ í¬í•¨
// 2. regionsì— ì‚¬ìš©ì ì„ í˜¸ ì§€ì—­ í¬í•¨
// 3. career_minì´ ì‚¬ìš©ì ì„ í˜¸ ê²½ë ¥ ë²”ìœ„ ë‚´
// 4. employee_typesì— ì‚¬ìš©ì ì„ í˜¸ ê³ ìš©í˜•íƒœ í¬í•¨
// 5. company_typeì´ ì‚¬ìš©ì ì„ í˜¸ ìœ í˜•ì— í¬í•¨
```

---

## 7. Axios ìš”ì²­ í—¤ë”

**íŒŒì¼**: `src/crawlers/zighang-full.js:7-10`

```javascript
const HEADERS = {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
  'Accept': 'text/html,application/xml',
};
```

---

## 8. Cheerio ì‚¬ìš© ì˜ˆì‹œ

```javascript
import * as cheerio from 'cheerio';

const $ = cheerio.load(html);

// CSS Selector
const title = $('h1').text();
const ldJson = $('script[type="application/ld+json"]').html();
const ogTitle = $('meta[property="og:title"]').attr('content');

// ë°˜ë³µë¬¸
$('div.item').each((i, el) => {
  const text = $(el).text();
  console.log(text);
});
```

---

## 9. ì „ì²´ í¬ë¡¤ë§ íë¦„

```
1. fetchSitemapIndex()
   â†’ sitemap-recruitment-*.xml ëª©ë¡ ê°€ì ¸ì˜¤ê¸°

2. fetchAllJobUrls(sinceDate)
   â†’ ê° ì‚¬ì´íŠ¸ë§µì—ì„œ ê³µê³  URL + lastmod ì¶”ì¶œ
   â†’ sinceDate ì´í›„ ìˆ˜ì •ëœ ê²ƒë§Œ í•„í„°ë§

3. crawlAll()
   â†’ entriesë¥¼ CONCURRENCY(5ê°œ)ì”© ë™ì‹œ í¬ë¡¤ë§
   â†’ fetchJobDetail() í˜¸ì¶œ
   â†’ ë°°ì¹˜(50ê°œ)ë§ˆë‹¤ Supabase upsert

4. fetchJobDetail(entry)
   â†’ RSC â†’ LD+JSON â†’ CSS Selector fallback
   â†’ í•„ìˆ˜ í•„ë“œ í™•ë³´
   â†’ return job object
```

---

## 10. ë””ë²„ê¹… íŒ

```javascript
// RSC chunks í™•ì¸
console.log('RSC chunks found:', matches.length);
console.log('First chunk preview:', chunks[0].substring(0, 200));
console.log('Has recruitment:', fullRsc.includes('"recruitment":{'));

// LD+JSON í™•ì¸
console.log('LD+JSON scripts:', $('script[type="application/ld+json"]').length);
$('script[type="application/ld+json"]').each((i, el) => {
  const data = JSON.parse($(el).html());
  console.log('Type:', data['@type']);
});

// CSS Selector í™•ì¸
console.log('Summary items:', $('div.bg-subtle.grid > div').length);
$('div.bg-subtle.grid > div').each((i, el) => {
  console.log(`Item ${i}:`, $(el).text().trim());
});
```

---

**ì°¸ê³ **: ì´ íŒŒì¼ì€ ê¸°ì¡´ ì½”ë“œ ì´í•´ë¥¼ ë•ê¸° ìœ„í•œ ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.
ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” `GEMINI_í¬ë¡¤ëŸ¬_ì¸ìˆ˜ì¸ê³„ì„œ.md`ì˜ 3ë‹¨ê³„ fallback ë¡œì§ì„ ë”°ë¼ì£¼ì„¸ìš”.
